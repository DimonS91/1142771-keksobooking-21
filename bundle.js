(()=>{"use strict";window.util={clickOnEsc:(e,t)=>{27===e.keyCode&&t()},clickOnEnter:(e,t)=>{13===e.keyCode&&t()},clickOnMouse:(e,t)=>{1===e.which&&t()},getRandomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e),getRandomArray:e=>e.filter((()=>Math.random()>=.5)),getRandomElement:e=>e[Math.floor(Math.random()*e.length)],debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},window.load=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e3,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},window.upload=(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?t(n.response):o("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e3,n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},n=(e,t)=>{t?e.textContent=t:e.style.display="none"};window.card={renderCard:r=>{const i=document.querySelector(".map__card");i&&i.remove(),t.appendChild((t=>{const r=e.cloneNode(!0);var i,d;i=r.querySelector(".popup__photos"),d=t.offer.photos,i.innerHTML="",d.length?d.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.width="45",t.height="40",t.alt="Фотография жилья",i.appendChild(t)})):i.style.display="none",((e,t)=>{e.innerHTML="",t.length?t.forEach((t=>{const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+t),e.appendChild(o)})):e.style.display="none"})(r.querySelector(".popup__features"),t.offer.features),n(r.querySelector(".popup__description"),t.offer.description),n(r.querySelector(".popup__text--capacity"),`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`),n(r.querySelector(".popup__text--time"),`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`),n(r.querySelector(".popup__type"),o[t.offer.type]),n(r.querySelector(".popup__text--price"),t.offer.price+"₽/ночь"),n(r.querySelector(".popup__text--address"),t.offer.address),n(r.querySelector(".popup__title"),t.offer.title),((e,t)=>{t?e.src=t:e.style.display="none"})(r.querySelector(".popup__avatar"),t.author.avatar);const c=r.querySelector(".popup__close"),a=()=>{r.remove()};return c.addEventListener("mousedown",(e=>{window.util.clickOnMouse(e,a)})),window.addEventListener("keydown",(e=>{window.util.clickOnEsc(e,a)})),r})(r))},removeCard:()=>{const e=document.querySelector(".map__card");e&&e.remove()}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=document.querySelector(".ad-form"),n=o.querySelectorAll("fieldset"),r=document.querySelector(".map__filters").querySelectorAll("select"),i=document.querySelector("#room_number"),d=o.querySelector("#type"),c=(e,t,o)=>{t.forEach((t=>{t.disabled=e})),o.forEach((t=>{t.disabled=e}))},a=e=>{window.filter.activateFilter(e)},s=()=>{t.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),c(!1,r,n),window.load(a,(()=>{})),window.form.checkRoom(i.value),window.form.typeHouse(d.value),window.form.createAddress(window.pin.positionPinDefault,!0)},l=t=>{window.util.clickOnMouse(t,s),e.removeEventListener("mousedown",l)},u=t=>{window.util.clickOnEnter(t,s),e.removeEventListener("keydown",u)};e.addEventListener("mousedown",l),e.addEventListener("keydown",u),c(!0,r,n),window.map={deactivationMap:()=>{t.classList.add("map--faded"),o.classList.add("ad-form--disabled"),c(!0,r,n),e.style.top=window.pin.positionPinDefault.y+"px",e.style.left=window.pin.positionPinDefault.x+"px",window.form.createAddress(window.pin.positionPinDefault,!0),e.addEventListener("mousedown",l),e.addEventListener("keydown",u)}}})(),(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();const n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const i={x:e.offsetLeft-n,y:e.offsetTop-r},d={top:130-e.offsetHeight-18,right:1200-e.offsetWidth/2,bottom:630-e.offsetHeight-18,left:0-e.offsetWidth/2};var c;(c=i).x<=d.left&&(c.x=d.left),c.x>=d.right&&(c.x=d.right),c.y<=d.top&&(c.y=d.top),c.y>=d.bottom&&(c.y=d.bottom),e.style.left=i.x+"px",e.style.top=i.y+"px",window.form.createAddress(i,!0)},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)}))})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");window.pin={renderPins:o=>{o.forEach((o=>{t.appendChild((t=>{const o=e.cloneNode(!0);o.querySelector("img").src=t.author.avatar,o.querySelector("img").alt=t.offer.title,o.style.left=t.location.x-20+"px",o.style.top=t.location.y-20-18+"px";const n=()=>{window.card.renderCard(t)};return o.addEventListener("mousedown",(e=>{window.util.clickOnMouse(e,n)})),o.addEventListener("keydown",(e=>{window.util.clickOnEnter(e,n)})),o})(o))}))},removePins:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},mainPin:{MAIN_PIN_WIDTH:65,MAIN_PIN_HEIGHT:65,PIN_TAIL:18},positionPinDefault:{x:570,y:375}}})(),(()=>{const e=document.querySelector("#address"),t=document.querySelector("#capacity").querySelectorAll("option"),o=document.querySelector("#room_number"),n=document.querySelector(".ad-form"),r=n.querySelector(".ad-form__reset"),i=n.querySelector("#title"),d=n.querySelector("#type"),c=document.querySelector("#timein"),a=document.querySelector("#timeout"),s=n.querySelector("#price"),l=["gif","jpg","jpeg","png"],u=document.querySelector(".ad-form-header__preview"),p=document.querySelector("#avatar"),m=document.querySelector("#images"),w=document.querySelector(".ad-form__photo"),y=(t,o)=>{e.value=o?`${Math.ceil(t.x+window.pin.mainPin.MAIN_PIN_WIDTH/2)}, ${Math.ceil(t.y+window.pin.mainPin.MAIN_PIN_HEIGHT+window.pin.mainPin.PIN_TAIL)}`:`${Math.ceil(570+window.pin.mainPin.MAIN_PIN_WIDTH/2)}, ${Math.ceil(375+window.pin.mainPin.MAIN_PIN_HEIGHT/2)}`};y(!1);const f={1:[1],2:[1,2],3:[1,2,3],100:[0]},v=e=>{t.forEach((e=>{e.disabled=!0})),f[e].forEach((e=>{t.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};o.addEventListener("change",(e=>{v(e.target.value)})),i.addEventListener("input",(()=>{const e=i.value.length;e<30?i.setCustomValidity("Еще "+(30-e)+" симв"):e>100?i.setCustomValidity("Удалите лишние "+(e-100)+" симв"):i.setCustomValidity(""),i.reportValidity()})),c.addEventListener("change",(()=>{a.value=c.value})),a.addEventListener("change",(()=>{c.value=a.value}));const h={bungalow:0,flat:1e3,house:5e3,palace:1e4},_=e=>{s.setAttribute("min",h[e]),s.setAttribute("placeholder",h[e])};d.addEventListener("change",(e=>{_(e.target.value)}));const E=document.querySelector("#error").content.querySelector(".error"),q=document.querySelector("#success").content.querySelector(".success"),S=()=>{const e=E.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e),g()},L=()=>{const e=q.cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e),k(),n.reset(),window.map.deactivationMap(),window.pin.removePins(),window.card.removeCard(),window.filter.resetFilter(),x()},g=()=>{const e=document.querySelector(".error"),t=document.querySelector(".error__button"),o=t=>{window.util.clickOnMouse(t,(()=>{e.remove()}))};window.addEventListener("keydown",(t=>{window.util.clickOnEsc(t,(()=>{e.remove()}))})),t.addEventListener("click",o),window.addEventListener("click",o)},k=()=>{const e=document.querySelector(".success");window.addEventListener("keydown",(t=>{window.util.clickOnEsc(t,(()=>{e.remove()}))})),window.addEventListener("click",(t=>{window.util.clickOnMouse(t,(()=>{})),e.remove()}))},M=(e,t)=>()=>{const o=e.files[0],n=o.name.toLowerCase();if(l.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{((e,t)=>{const o=document.createElement("img");o.classList.add("photo-preview"),o.src=e.result,o.style.width="70px",o.style.height="70px",o.style.borderRadius="5px",t.style.position="relative",o.style.position="absolute",o.style.left="0",t.appendChild(o)})(e,t)})),e.readAsDataURL(o)}e.addEventListener("change",(()=>{x()}))},x=()=>{document.querySelectorAll(".photo-preview").forEach((e=>{e.remove()}))};p.addEventListener("change",M(p,u)),m.addEventListener("change",M(m,w)),n.addEventListener("submit",(e=>{e.preventDefault(),window.upload(new FormData(n),L,S)})),r.addEventListener("click",(()=>{n.reset(),window.map.deactivationMap(),window.pin.removePins(),window.card.removeCard(),window.filter.resetFilter(),x()})),window.form={createAddress:y,checkRoom:v,typeHouse:_}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll("select, input"),o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),d=document.querySelector("#housing-features");let c=[];const a=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),s=e=>e.filter((e=>a(o,e.offer,"type")&&(e=>"low"===n.value?e.offer.price<1e4:"middle"===n.value?e.offer.price>=1e4&&e.offer.price<=5e4:"high"===n.value?e.offer.price>=5e4:e.offer.price>0)(e)&&a(r,e.offer,"rooms")&&(e=>a(i,e.offer,"guests"))(e)&&(e=>{const t=d.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(e))).slice(0,5);e.addEventListener("change",window.util.debounce((()=>{window.card.removeCard(),window.pin.removePins(),window.pin.renderPins(s(c))}))),window.filter={resetFilter:()=>{t.forEach((e=>{e.value="any"}))},activateFilter:e=>{c=e,window.pin.renderPins(s(c))}}})()})();